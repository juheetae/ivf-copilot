<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IVF Copilot MVP</title>

<style>
body {
  font-family: system-ui;
  max-width: 700px;
  margin: 40px auto;
}
.card {
  border:1px solid #ddd;
  padding:16px;
  border-radius:12px;
  margin-bottom:16px;
}
textarea, input, select, button {
  width:100%;
  margin-top:8px;
  padding:10px;
}
pre {
  background:#f6f6f6;
  padding:12px;
  border-radius:10px;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<h1>IVF Copilot (MVP)</h1>

<div class="card">
<h2>1) ë‚´ ì •ë³´ ì…ë ¥</h2>

<label>ë‚˜ì´</label>
<input id="age" type="number">

<label>ë°°ì•„ ì¼ìˆ˜</label>
<select id="embryo_day">
<option value="5">5ì¼ë°°ì•„</option>
<option value="3">3ì¼ë°°ì•„</option>
</select>

<label>ì´ì‹ì¼</label>
<input id="transfer_date" type="date">

<button onclick="save()">ì €ì¥</button>
</div>

<div class="card">
<h2>2) ì˜¤ëŠ˜ ìƒíƒœ</h2>
<div id="dash"></div>
</div>

<div class="card">
<h2>3) ì§ˆë¬¸í•˜ê¸°</h2>
<textarea id="question"></textarea>
<button onclick="ask()">AIì—ê²Œ ë¬¼ì–´ë³´ê¸°</button>
<div id="paywall" class="card" style="display:none;">
  <h3>ì˜¤ëŠ˜ ë¬´ë£Œ ì§ˆë¬¸ì„ ë‹¤ ì¼ì–´ìš”</h3>
  <p style="color:#666;">í”„ë¦¬ë¯¸ì—„(ì¤€ë¹„ì¤‘)ì„ ì—´ë©´ ë¬´ì œí•œ ì§ˆë¬¸ + ì´ì‹ì¼ë³„ ê°€ì´ë“œê°€ ì œê³µë¼ìš”.</p>

  <label>ì•Œë¦¼ ë°›ê¸°(ì´ë©”ì¼ ë˜ëŠ” ì¹´í†¡ ì•„ì´ë””)</label>
  <input id="lead" type="text" placeholder="ì˜ˆ: email@domain.com ë˜ëŠ” ì¹´í†¡ID" />
  <button id="leadBtn">ì•Œë¦¼ ì‹ ì²­</button>

  <p id="leadMsg" style="color:#666; margin-top:8px;"></p>
</div>

<h3>ë‹µë³€</h3>
<pre id="answerBox">(ì•„ì§ ì—†ìŒ)</pre>

<h3>ìµœê·¼ ê¸°ë¡</h3>
<div id="historyBox"></div>
</div>

<script>
const LS="ivf_user";
const FREE_DAILY_LIMIT = 2;

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `ivf_daily_count_${y}-${m}-${day}`;
}

function getTodayCount(){
  return Number(localStorage.getItem(todayKey()) || "0");
}

function incTodayCount(){
  const next = getTodayCount() + 1;
  localStorage.setItem(todayKey(), String(next));
  return next;
}

function showPaywall(){
  document.getElementById("paywall").style.display = "block";
}
function hidePaywall(){
  document.getElementById("paywall").style.display = "none";
}

function save(){
 const data={
   age:age.value,
   embryo_day:embryo_day.value,
   transfer_date:transfer_date.value
 };
 localStorage.setItem(LS,JSON.stringify(data));
 renderDash();
}

function renderDash(){
 const d=JSON.parse(localStorage.getItem(LS)||"{}");
 if(!d.transfer_date) return;
 const diff=Math.floor((Date.now()-new Date(d.transfer_date))/86400000);
 dash.innerText=`ì˜¤ëŠ˜ì€ ${diff<0?0:diff} DPT`;
}

async function ask(){

  const q = (question.value || "").trim();
  if(!q){ alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"); return; }

  hidePaywall();
  const count = getTodayCount();
  if(count >= FREE_DAILY_LIMIT){
    showPaywall();
    answerBox.textContent = "ì˜¤ëŠ˜ì€ ë¬´ë£Œ ì§ˆë¬¸ 2íšŒê¹Œì§€ ê°€ëŠ¥í•´ìš” ğŸ™‚";
    return;
  }

  answerBox.textContent = "ìƒì„±ì¤‘...";

  const d = JSON.parse(localStorage.getItem(LS) || "{}");
  const diff = d.transfer_date ? Math.floor((Date.now() - new Date(d.transfer_date)) / 86400000) : 0;
  const dpt = diff < 0 ? 0 : diff;

  try{
    const r = await fetch("/api/answer"), {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        question: q,
        dpt: dpt,
        user_state: d
      })
    });

    const data = await r.json();
    const ans = data.answer || "(ë¹ˆ ì‘ë‹µ)";
    answerBox.textContent = ans;
incTodayCount();
    saveHistory(q, ans, dpt);
    renderHistory();
  }catch(e){
    answerBox.textContent = "ì˜¤ë¥˜: " + e;
  }
}

function saveHistory(q, a, dpt){
  const NEW_KEY = "ivf_history";
  const OLD_KEY = "history";

  
  const raw = localStorage.getItem(NEW_KEY) || localStorage.getItem(OLD_KEY) || "[]";
  const h = JSON.parse(raw);

  h.unshift({ ts: Date.now(), dpt, q, a });
  localStorage.setItem(NEW_KEY, JSON.stringify(h.slice(0,10)));
}

function renderHistory(){
  const NEW_KEY = "ivf_history";
  const OLD_KEY = "history";

 
  const raw = localStorage.getItem(NEW_KEY) || localStorage.getItem(OLD_KEY) || "[]";
  const h = JSON.parse(raw);

  const box = document.getElementById("historyBox");
  if(!box) return;

  if(h.length === 0){
    box.innerHTML = '<div style="color:#666;">(ì•„ì§ ì—†ìŒ)</div>';
    return;
  }

  box.innerHTML = h.map(item => {
    const q = item.q ?? "";
    const a = item.a ?? "";
    const ts = item.ts ? new Date(item.ts).toLocaleString("ko-KR") : "";
    const dptText = (item.dpt ?? "") !== "" ? ` Â· ${item.dpt}DPT` : "";

    return `
      <div class="card">
        <div style="color:#666; font-size:12px;">${ts}${dptText}</div>
        <div style="margin-top:6px;"><b>Q.</b> ${q}</div>
        <div style="margin-top:6px; white-space:pre-wrap;"><b>A.</b>\n${a}</div>
      </div>
    `;
  }).join("");
}

renderDash();
renderDash();


if(!localStorage.getItem("ivf_history") && localStorage.getItem("history")){
  localStorage.setItem("ivf_history", localStorage.getItem("history"));
}

renderHistory();

</script>
document.getElementById("leadBtn")?.addEventListener("click", () => {
  const v = (document.getElementById("lead").value || "").trim();
  const msg = document.getElementById("leadMsg");
  if(!v){
    msg.textContent = "ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
    return;
  }
  const leads = JSON.parse(localStorage.getItem("ivf_leads") || "[]");
  leads.unshift({ ts: Date.now(), contact: v });
  localStorage.setItem("ivf_leads", JSON.stringify(leads.slice(0,50)));
  msg.textContent = "ì‹ ì²­ ì™„ë£Œ! í”„ë¦¬ë¯¸ì—„ ì˜¤í”ˆë˜ë©´ ì•Œë ¤ë“œë¦´ê²Œìš”.";
});

</body>
</html>
