<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IVF Copilot MVP</title>

<style>
body {
  font-family: system-ui;
  max-width: 700px;
  margin: 40px auto;
}
.card {
  border:1px solid #ddd;
  padding:16px;
  border-radius:12px;
  margin-bottom:16px;
}
textarea, input, select, button {
  width:100%;
  margin-top:8px;
  padding:10px;
}
pre {
  background:#f6f6f6;
  padding:12px;
  border-radius:10px;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<h1>IVF Copilot (MVP)</h1>

<div class="card">
<h2>1) 내 정보 입력</h2>

<label>나이</label>
<input id="age" type="number">

<label>배아 일수</label>
<select id="embryo_day">
<option value="5">5일배아</option>
<option value="3">3일배아</option>
</select>

<label>이식일</label>
<input id="transfer_date" type="date">

<button onclick="save()">저장</button>
</div>

<div class="card">
<h2>2) 오늘 상태</h2>
<div id="dash"></div>
</div>

<div class="card">
<h2>3) 질문하기</h2>
<textarea id="question"></textarea>
<button onclick="ask()">AI에게 물어보기</button>
<div id="paywall" class="card" style="display:none;">
  <h3>오늘 무료 질문을 다 썼어요</h3>
  <p style="color:#666;">프리미엄(준비중)을 열면 무제한 질문 + 이식일별 가이드가 제공돼요.</p>

  <label>알림 받기(이메일 또는 카톡 아이디)</label>
  <input id="lead" type="text" placeholder="예: email@domain.com 또는 카톡ID" />
  <button id="leadBtn">알림 신청</button>

  <p id="leadMsg" style="color:#666; margin-top:8px;"></p>
</div>

<h3>답변</h3>
<pre id="answerBox">(아직 없음)</pre>

<h3>최근 기록</h3>
<div id="historyBox"></div>
</div>

<script>
const LS="ivf_user";

function save(){
  const data={
    age: age.value,
    embryo_day: embryo_day.value,
    transfer_date: transfer_date.value
  };
  localStorage.setItem(LS, JSON.stringify(data));
  renderDash();
}

function renderDash(){
  const d = JSON.parse(localStorage.getItem(LS) || "{}");
  if(!d.transfer_date) return;
  const diff = Math.floor((Date.now() - new Date(d.transfer_date)) / 86400000);
  dash.innerText = `오늘은 ${diff < 0 ? 0 : diff} DPT`;
}

async function ask(){
  const q = (question.value || "").trim();
  if(!q){ alert("질문을 입력해주세요"); return; }

  answerBox.textContent = "생성중...";

  const d = JSON.parse(localStorage.getItem(LS) || "{}");
  const diff = d.transfer_date ? Math.floor((Date.now() - new Date(d.transfer_date)) / 86400000) : 0;
  const dpt = diff < 0 ? 0 : diff;

  try{
    // ✅ 핵심: 배포/로컬 모두에서 동작하는 상대경로
    const r = await fetch("/api/answer", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        question: q,
        dpt: dpt,
        user_state: d
      })
    });

    // 에러 응답도 텍스트로 보여주기
    if(!r.ok){
      const t = await r.text();
      throw new Error(`${r.status} ${t}`);
    }

    const data = await r.json();
    const ans = data.answer || "(빈 응답)";
    answerBox.textContent = ans;

    // (히스토리 저장은 너가 쓰던 함수 있으면 유지)
    if(typeof saveHistory === "function"){
      saveHistory(q, ans, dpt);
    }
    if(typeof renderHistory === "function"){
      renderHistory();
    }
  }catch(e){
    answerBox.textContent = "오류: " + (e?.message || e);
  }
}

renderDash();
function saveHistory(q, a, dpt){
  const KEY = "ivf_history";
  const h = JSON.parse(localStorage.getItem(KEY) || "[]");
  h.unshift({ ts: Date.now(), dpt, q, a });
  localStorage.setItem(KEY, JSON.stringify(h.slice(0, 10)));
}

function renderHistory(){
  const KEY = "ivf_history";
  const h = JSON.parse(localStorage.getItem(KEY) || "[]");
  const box = document.getElementById("historyBox");
  if(!box) return;

  if(h.length === 0){
    box.innerHTML = '<div style="color:#666;">(아직 없음)</div>';
    return;
  }

  box.innerHTML = h.map(item => `
    <div class="card" style="margin-top:12px;">
      <div style="color:#666; font-size:12px;">
        ${new Date(item.ts).toLocaleString("ko-KR")} · ${item.dpt} DPT
      </div>
      <div style="margin-top:6px;"><b>Q.</b> ${escapeHtml(item.q)}</div>
      <div style="margin-top:6px; white-space:pre-wrap;"><b>A.</b>\n${escapeHtml(item.a)}</div>
    </div>
  `).join("");
}

// XSS 방지용 (답변에 특수문자 있어도 안전)
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}


</script>
document.getElementById("leadBtn")?.addEventListener("click", () => {
  const v = (document.getElementById("lead").value || "").trim();
  const msg = document.getElementById("leadMsg");
  if(!v){
    msg.textContent = "연락처를 입력해 주세요.";
    return;
  }
  const leads = JSON.parse(localStorage.getItem("ivf_leads") || "[]");
  leads.unshift({ ts: Date.now(), contact: v });
  localStorage.setItem("ivf_leads", JSON.stringify(leads.slice(0,50)));
  msg.textContent = "신청 완료! 프리미엄 오픈되면 알려드릴게요.";
});

</body>
</html>
