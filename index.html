<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IVF Copilot MVP</title>

<style>
:root{
  --bg: #f5f5f7;
  --card: rgba(255,255,255,.78);
  --text: #1d1d1f;
  --muted: rgba(29,29,31,.62);
  --line: rgba(0,0,0,.08);

  --accent: #007aff;        /* iOS blue */
  --accent2: rgba(0,122,255,.12);

  --radius: 18px;
  --shadow: 0 18px 50px rgba(0,0,0,.08);
  --shadow2: 0 1px 0 rgba(0,0,0,.04);
}

*{ box-sizing:border-box; }

html, body { height: 100%; }

body{
  margin:0;
  padding: 40px 16px 64px;
  background:
    radial-gradient(900px 450px at 10% 0%, rgba(0,122,255,.18), transparent 60%),
    radial-gradient(700px 380px at 90% 12%, rgba(52,199,89,.14), transparent 55%),
    var(--bg);
  color: var(--text);

  font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
               "SF Pro Display","SF Pro Text","Apple SD Gothic Neo","Noto Sans KR", sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

main{
  max-width: 760px;
  margin: 0 auto;
}

h1{
  font-size: 28px;
  line-height: 1.15;
  letter-spacing: -0.02em;
  margin: 0 0 10px;
}

.subtitle{
  color: var(--muted);
  font-size: 14px;
  line-height: 1.5;
  margin: 0 0 18px;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 12px;
  border-radius: 999px;
  background: var(--accent2);
  border: 1px solid rgba(0,122,255,.18);
  color: rgba(0,122,255,.95);
  font-size: 12px;
  font-weight: 600;
}

.card{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 18px;
  margin: 14px 0;
  box-shadow: var(--shadow2), var(--shadow);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
}

h2{
  font-size: 16px;
  letter-spacing: -0.01em;
  margin: 0 0 12px;
}

label{
  display:block;
  margin-top: 12px;
  font-size: 12px;
  color: var(--muted);
  letter-spacing: 0.01em;
}

input, select, textarea{
  width:100%;
  margin-top: 8px;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.92);
  color: var(--text);
  outline: none;
  transition: box-shadow .18s ease, border-color .18s ease, transform .06s ease;
}

textarea{
  min-height: 92px;
  resize: vertical;
}

input:focus, select:focus, textarea:focus{
  border-color: rgba(0,122,255,.55);
  box-shadow: 0 0 0 4px rgba(0,122,255,.16);
}

button{
  width:100%;
  margin-top: 12px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.08);
  background: var(--accent);
  color: #fff;
  font-weight: 700;
  letter-spacing: -0.01em;
  cursor:pointer;
  transition: transform .06s ease, filter .18s ease, box-shadow .18s ease;
  box-shadow: 0 10px 24px rgba(0,122,255,.22);
}

button:hover{ filter: brightness(1.03); }
button:active{ transform: translateY(1px); }

button.secondary{
  background: rgba(255,255,255,.9);
  color: var(--text);
  border: 1px solid rgba(0,0,0,.10);
  box-shadow: 0 10px 24px rgba(0,0,0,.06);
}

pre{
  margin: 10px 0 0;
  padding: 14px;
  border-radius: 16px;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.88);
  color: var(--text);
  white-space: pre-wrap;
  line-height: 1.55;
}

.small{
  color: var(--muted);
  font-size: 12px;
  line-height: 1.5;
}

hr.sep{
  border:0;
  height:1px;
  background: rgba(0,0,0,.08);
  margin: 14px 0;
}

#dash{
  font-size: 14px;
  color: var(--muted);
}

@media (max-width: 420px){
  body{ padding-top: 28px; }
  h1{ font-size: 24px; }
  .card{ padding: 16px; border-radius: 16px; }
}
/* ===== Apple-ish motion polish ===== */
.card{
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.card:hover{
  transform: translateY(-2px);
  border-color: rgba(0,0,0,.10);
  box-shadow: 0 22px 70px rgba(0,0,0,.10), 0 1px 0 rgba(0,0,0,.04);
}

button{
  transition: transform .08s ease, filter .18s ease, box-shadow .18s ease;
}
button:active{
  transform: translateY(1px) scale(.99);
  filter: brightness(.98);
}

input, select, textarea{
  transition: box-shadow .18s ease, border-color .18s ease, transform .08s ease;
}
input:focus, select:focus, textarea:focus{
  transform: scale(1.01);
}

/* nicer selection */
::selection{
  background: rgba(0,122,255,.22);
}

/* subtle divider inside cards */
.section-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.section-title .hint{
  font-size:12px;
  color: rgba(29,29,31,.55);
}
/* ===== Health-ish UI ===== */
.header{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-bottom: 18px;
}

.header-top{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

.title-wrap h1{ margin:0; }
.title-wrap .subtitle{
  margin:0;
  color: var(--muted);
  font-size: 14px;
}

.chips{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top: 2px;
}

.chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 12px;
  border-radius: 999px;
  border:1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.72);
  color: rgba(29,29,31,.80);
  font-size: 12px;
  font-weight: 600;
  box-shadow: 0 8px 18px rgba(0,0,0,.06);
}

.chip.blue{
  border-color: rgba(0,122,255,.20);
  background: rgba(0,122,255,.10);
  color: rgba(0,122,255,.95);
}
.chip.green{
  border-color: rgba(52,199,89,.24);
  background: rgba(52,199,89,.10);
  color: rgba(18,124,48,.95);
}
.chip.orange{
  border-color: rgba(255,149,0,.24);
  background: rgba(255,149,0,.12);
  color: rgba(140,78,0,.95);
}

.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}
@media (max-width: 640px){
  .grid2{ grid-template-columns: 1fr; }
}

.kpi{
  padding: 14px;
  border-radius: 16px;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.70);
}
.kpi .kpi-title{
  font-size: 12px;
  color: var(--muted);
  margin:0;
}
.kpi .kpi-value{
  margin:6px 0 0;
  font-size: 18px;
  font-weight: 750;
  letter-spacing: -0.02em;
}

.helper{
  margin-top: 10px;
  color: var(--muted);
  font-size: 12px;
  line-height: 1.5;
}
</style>
</head>

<body>
<main>
  <div class="header">
  <div class="header-top">
    <div class="title-wrap">
      <h1>IVF Copilot</h1>
      <p class="subtitle">DPT 계산 → 증상/불안 질문 → AI 답변 (의료 조언 아님)</p>
    </div>
  </div>

  <div class="chips">
    <span class="chip blue">의료 조언 아님</span>
    <span class="chip green">최근 기록은 기기 내 저장</span>
    <span class="chip orange">응급/위험 신호는 병원</span>
  </div>
</div>
  <!-- 기존 카드들 그대로 -->

<div class="card">
<h2>1) 내 정보 입력</h2>

<label>나이</label>
<input id="age" type="number">

<label>배아 일수</label>
<select id="embryo_day">
<option value="5">5일배아</option>
<option value="3">3일배아</option>
</select>

<label>이식일</label>
<input id="transfer_date" type="date">

<button class="secondary" onclick="save()">저장</button>
</div>

<div class="card">
  <h2>2) 오늘 상태</h2>

  <div class="grid2">
    <div class="kpi">
      <p class="kpi-title">오늘은</p>
      <p class="kpi-value" id="dash">—</p>
    </div>

    <div class="kpi">
      <p class="kpi-title">안내</p>
      <p class="kpi-value" style="font-size:13px; font-weight:650; color:rgba(29,29,31,.72); line-height:1.4;">
        불편이 심하거나 출혈/고열 등은 바로 병원에 문의하세요.
      </p>
    </div>
  </div>

  <div class="helper">DPT는 “이식일 기준 경과일”로 계산됩니다.</div>
</div>

<div class="card">
<h2>3) 질문하기</h2>
<textarea id="question"></textarea>
<button onclick="ask()">AI에게 물어보기</button>
<div id="paywall" class="card" style="display:none;">
  <h3>오늘 무료 질문을 다 썼어요</h3>
  <p style="color:#666;">프리미엄(준비중)을 열면 무제한 질문 + 이식일별 가이드가 제공돼요.</p>

  <label>알림 받기(이메일 또는 카톡 아이디)</label>
  <input id="lead" type="text" placeholder="예: email@domain.com 또는 카톡ID" />
  <button id="leadBtn">알림 신청</button>

  <p id="leadMsg" style="color:#666; margin-top:8px;"></p>
</div>

<h3>답변</h3>
<pre id="answerBox">(아직 없음)</pre>

<h3>최근 기록</h3>
<div id="historyBox"></div>
</div>

<script>
const LS="ivf_user";

function save(){
  const data={
    age: age.value,
    embryo_day: embryo_day.value,
    transfer_date: transfer_date.value
  };
  localStorage.setItem(LS, JSON.stringify(data));
  renderDash();
}

function renderDash(){
  const d = JSON.parse(localStorage.getItem(LS) || "{}");
  if(!d.transfer_date) return;
  const diff = Math.floor((Date.now() - new Date(d.transfer_date)) / 86400000);
dash.innerText = `${diff<0?0:diff} DPT`;}

async function ask(){
  const q = (question.value || "").trim();
  if(!q){ alert("질문을 입력해주세요"); return; }

  answerBox.textContent = "생성중...";

  const d = JSON.parse(localStorage.getItem(LS) || "{}");
  const diff = d.transfer_date ? Math.floor((Date.now() - new Date(d.transfer_date)) / 86400000) : 0;
  const dpt = diff < 0 ? 0 : diff;

  try{
    // ✅ 핵심: 배포/로컬 모두에서 동작하는 상대경로
    const r = await fetch("/api/answer", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        question: q,
        dpt: dpt,
        user_state: d
      })
    });

    // 에러 응답도 텍스트로 보여주기
    if(!r.ok){
      const t = await r.text();
      throw new Error(`${r.status} ${t}`);
    }

    const data = await r.json();
    const ans = data.answer || "(빈 응답)";
    answerBox.textContent = ans;

    // (히스토리 저장은 너가 쓰던 함수 있으면 유지)
    if(typeof saveHistory === "function"){
      saveHistory(q, ans, dpt);
    }
    if(typeof renderHistory === "function"){
      renderHistory();
    }
  }catch(e){
    answerBox.textContent = "오류: " + (e?.message || e);
  }
}

renderDash();
function saveHistory(q, a, dpt){
  const KEY = "ivf_history";
  const h = JSON.parse(localStorage.getItem(KEY) || "[]");
  h.unshift({ ts: Date.now(), dpt, q, a });
  localStorage.setItem(KEY, JSON.stringify(h.slice(0, 10)));
}

function renderHistory(){
  const KEY = "ivf_history";
  const h = JSON.parse(localStorage.getItem(KEY) || "[]");
  const box = document.getElementById("historyBox");
  if(!box) return;

  if(h.length === 0){
    box.innerHTML = '<div style="color:#666;">(아직 없음)</div>';
    return;
  }

  box.innerHTML = h.map(item => `
    <div class="card" style="margin-top:12px;">
      <div style="color:#666; font-size:12px;">
        ${new Date(item.ts).toLocaleString("ko-KR")} · ${item.dpt} DPT
      </div>
      <div style="margin-top:6px;"><b>Q.</b> ${escapeHtml(item.q)}</div>
      <div style="margin-top:6px; white-space:pre-wrap;"><b>A.</b>\n${escapeHtml(item.a)}</div>
    </div>
  `).join("");
}

// XSS 방지용 (답변에 특수문자 있어도 안전)
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}


</script>
</main>
</body>
</html>
